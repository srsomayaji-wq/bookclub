<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sri's Book Recommendations</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f4f5;
      --card: #ffffff;
      --text: #1a1a1a;
      --text-muted: #71717a;
      --border: #e4e4e7;
      --input-bg: #fafafa;
      --btn-bg: #27272a;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 3rem 1.5rem;
    }

    .page {
      max-width: 480px;
      margin: 0 auto;
      text-align: center;
    }

    header {
      margin-bottom: 2.5rem;
    }

    h1 {
      font-size: clamp(1.75rem, 4vw, 2.25rem);
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    .subtitle {
      font-size: 1rem;
      color: var(--text-muted);
      font-weight: 400;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 2rem;
      text-align: left;
    }

    .card h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    .card-desc {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group:last-of-type {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 0.75rem 1rem;
      font-family: inherit;
      font-size: 0.95rem;
      color: var(--text);
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2371717a' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      padding-right: 2.5rem;
    }

    input[type="text"] {
      background-image: none;
      padding-right: 1rem;
    }

    select:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: var(--text-muted);
    }

    .btn {
      display: block;
      width: 100%;
      padding: 0.875rem 1.5rem;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      background: var(--btn-bg);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn:active {
      opacity: 0.95;
    }

    .btn:disabled {
      background: #a1a1aa;
      color: #fff;
      cursor: not-allowed;
      opacity: 0.8;
    }

    .btn:disabled:hover {
      opacity: 0.8;
    }

    .admin-link {
      display: block;
      text-align: center;
      margin-top: 1.25rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .admin-link a {
      color: var(--text-muted);
      text-decoration: underline;
    }

    .admin-link a:hover {
      color: var(--text);
    }

    .saved-books {
      margin-top: 2.5rem;
      text-align: left;
    }

    .saved-books.hidden {
      display: none;
    }

    .saved-books h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 1rem;
    }

    .saved-books-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .saved-book-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.25rem;
      background: var(--card);
      border-radius: 10px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .saved-book-item img {
      width: 56px;
      height: 84px;
      object-fit: cover;
      border-radius: 6px;
      background: var(--bg);
      flex-shrink: 0;
    }

    .saved-book-item-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .saved-book-item-title {
      display: block;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text);
      line-height: 1.3;
    }

    .saved-book-item-author {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .saved-book-item-stars {
      display: flex;
      align-items: center;
      gap: 2px;
      margin-top: 0.15rem;
    }

    .saved-book-item-stars svg {
      width: 0.85rem;
      height: 0.85rem;
    }

    .saved-book-item-stars .rating-val {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      margin-left: 0.3rem;
    }

    .saved-book-reaction {
      flex-shrink: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: none;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.15s;
      color: var(--text-muted);
    }

    .saved-book-reaction:hover {
      background: #f1f5f9;
    }

    .saved-book-reaction svg {
      width: 1.1rem;
      height: 1.1rem;
    }

    .saved-book-reaction.liked {
      color: var(--btn-bg);
    }

    .saved-book-remove {
      flex-shrink: 0;
      width: 1.5rem;
      height: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: none;
      cursor: pointer;
      border-radius: 50%;
      color: #cbd5e1;
      transition: color 0.15s, background 0.15s;
      padding: 0;
      margin-left: 0.25rem;
    }

    .saved-book-remove:hover {
      color: #ef4444;
      background: #fef2f2;
    }

    .saved-book-remove svg {
      width: 0.85rem;
      height: 0.85rem;
    }

    /* ── Responsive ── */

    /* Mobile */
    @media (max-width: 520px) {
      body {
        padding: 2rem 1rem;
      }

      .card {
        padding: 1.5rem 1.25rem;
      }

      .card h2 {
        font-size: 1.1rem;
      }

      .btn {
        padding: 0.75rem 1.25rem;
        font-size: 0.95rem;
      }

      .saved-book-item {
        padding: 0.75rem 1rem;
        gap: 0.75rem;
      }

      .saved-book-item img {
        width: 48px;
        height: 72px;
      }

      .saved-book-item-title {
        font-size: 0.9rem;
      }

      .saved-book-item-author {
        font-size: 0.8rem;
      }
    }

    /* Tablet */
    @media (min-width: 521px) and (max-width: 768px) {
      body {
        padding: 2.5rem 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Sri's Book Recommendations</h1>
      <p class="subtitle">Discover your next favorite book with personalized recommendations</p>
    </header>

    <div class="card">
      <h2>Find Your Next Great Read</h2>
      <p class="card-desc">Answer a few questions and we'll recommend the perfect book for you</p>

      <form id="recommend-form" novalidate>
        <div class="form-group">
          <label for="genre">What genre are you in the mood for?</label>
          <select id="genre" name="genre" required>
            <option value="" disabled selected>Select a genre</option>
            <option value="escapist">Escapist</option>
            <option value="mystery-suspense">Mystery/Suspense</option>
            <option value="emotional">Emotional</option>
            <option value="thoughtful">Thoughtful</option>
            <option value="factual">Factual</option>
            <option value="self-help">Self-Help</option>
          </select>
        </div>

        <div class="form-group">
          <label for="emotional-weight">Emotional weight</label>
          <select id="emotional-weight" name="emotional_weight" required>
            <option value="" disabled selected>Select emotional weight</option>
            <option value="light">Light</option>
            <option value="bittersweet">Bittersweet</option>
            <option value="heavy">Heavy</option>
            <option value="any">Any</option>
          </select>
        </div>

        <div class="form-group">
          <label for="pace">Pace</label>
          <select id="pace" name="pace" required>
            <option value="" disabled selected>Select pace</option>
            <option value="fast">Fast</option>
            <option value="moderate">Moderate</option>
            <option value="slow">Slow</option>
            <option value="any">Any</option>
          </select>
        </div>

        <div class="form-group">
          <label for="focus">Focus</label>
          <select id="focus" name="focus" required>
            <option value="" disabled selected>Select focus</option>
            <option value="plot">Plot</option>
            <option value="character">Character</option>
            <option value="balanced">Balanced</option>
            <option value="any">Any</option>
          </select>
        </div>

        <div class="form-group">
          <label for="length">Length</label>
          <select id="length" name="length" required>
            <option value="" disabled selected>Select length</option>
            <option value="short">Short (under 200 pages)</option>
            <option value="medium">Medium (201-400 pages)</option>
            <option value="long">Long (401-600 pages)</option>
            <option value="epic">Epic (600+ pages)</option>
            <option value="any">Any</option>
          </select>
        </div>

        <button type="submit" class="btn" id="get-recommendation-btn" disabled>Get Recommendation</button>
      </form>
      <p class="admin-link"><a href="booklist.html">Book List</a></p>
    </div>

    <section class="saved-books hidden" id="saved-books-section" aria-label="Saved books">
      <h2>Saved Books</h2>
      <ul class="saved-books-list" id="saved-books-list"></ul>
    </section>
  </div>

  <script>
    (function () {
      var SAVED_KEY = 'bookRecommendationSaved';

      var form = document.getElementById('recommend-form');
      var submitBtn = document.getElementById('get-recommendation-btn');
      var fields = [
        document.getElementById('genre'),
        document.getElementById('emotional-weight'),
        document.getElementById('pace'),
        document.getElementById('focus'),
        document.getElementById('length')
      ];

      function isFormComplete() {
        return fields.every(function (field) {
          return field && field.value && field.value.trim() !== '';
        });
      }

      function updateButtonState() {
        submitBtn.disabled = !isFormComplete();
      }

      fields.forEach(function (field) {
        if (field) field.addEventListener('change', updateButtonState);
      });
      updateButtonState();

      // Backend API base URL (change for production)
      var API_BASE = window.location.hostname === 'localhost'
        ? 'http://localhost:8000'
        : 'https://book-rec-api.onrender.com';

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        if (!isFormComplete()) return;

        var btnText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Loading…';

        var body = {
          genre_intent: document.getElementById('genre').value,
          pace: document.getElementById('pace').value,
          plot_character: document.getElementById('focus').value,
          mood_finish: document.getElementById('emotional-weight').value,
          length: document.getElementById('length').value
        };

        fetch(API_BASE + '/recommend', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (err) { throw err; });
            return res.json();
          })
          .then(function (data) {
            sessionStorage.setItem('recommendationResult', JSON.stringify(data));
            window.location.href = 'results.html';
          })
          .catch(function (err) {
            submitBtn.disabled = false;
            submitBtn.textContent = btnText;
            var msg = (err && err.detail) ? (typeof err.detail === 'string' ? err.detail : JSON.stringify(err.detail)) : 'Could not get recommendations. Is the server running? Have you uploaded a CSV?';
            alert(msg);
          });
      });

      function getSavedBooks() {
        try {
          var raw = localStorage.getItem(SAVED_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          return [];
        }
      }

      function miniStarsHtml(rating) {
        var html = '';
        var fullStars = Math.floor(rating);
        var halfStar = (rating - fullStars) >= 0.25;
        var i;
        for (i = 0; i < fullStars; i++) {
          html += '<svg viewBox="0 0 20 20" fill="#f59e0b"><path d="M10 1.12l2.47 5.01 5.53.8-4 3.9.94 5.5L10 13.77l-4.94 2.6.94-5.5-4-3.9 5.53-.8z"/></svg>';
        }
        if (halfStar) {
          html += '<svg viewBox="0 0 20 20"><defs><linearGradient id="hg"><stop offset="50%" stop-color="#f59e0b"/><stop offset="50%" stop-color="#d1d5db"/></linearGradient></defs><path fill="url(#hg)" d="M10 1.12l2.47 5.01 5.53.8-4 3.9.94 5.5L10 13.77l-4.94 2.6.94-5.5-4-3.9 5.53-.8z"/></svg>';
          fullStars++;
        }
        for (i = fullStars + (halfStar ? 0 : 0); i < 5; i++) {
          if (halfStar && i < fullStars) continue;
          html += '<svg viewBox="0 0 20 20" fill="#d1d5db"><path d="M10 1.12l2.47 5.01 5.53.8-4 3.9.94 5.5L10 13.77l-4.94 2.6.94-5.5-4-3.9 5.53-.8z"/></svg>';
        }
        html += '<span class="rating-val">' + rating.toFixed(1) + '</span>';
        return html;
      }

      function reactionIconHtml(reaction) {
        if (reaction === 'like') {
          return '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M2 20h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1H2v11zm19.83-7.12c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66a4.8 4.8 0 0 0-.88-1.22L14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.84C7 18.95 8.05 20 9.34 20h8.11c.7 0 1.36-.37 1.72-.97l2.66-6.15z"/></svg>';
        }
        // Outline thumbs-up for no reaction
        return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 20h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1H2v11zm19.83-7.12c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66a4.8 4.8 0 0 0-.88-1.22L14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.84C7 18.95 8.05 20 9.34 20h8.11c.7 0 1.36-.37 1.72-.97l2.66-6.15z"/></svg>';
      }

      function setSavedBooks(books) {
        localStorage.setItem(SAVED_KEY, JSON.stringify(books));
      }

      function renderSavedList() {
        var list = document.getElementById('saved-books-list');
        var section = document.getElementById('saved-books-section');
        var saved = getSavedBooks();
        list.innerHTML = '';
        if (saved.length === 0) {
          section.classList.add('hidden');
          return;
        }
        section.classList.remove('hidden');
        var placeholderCover = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="56" height="84" viewBox="0 0 56 84"%3E%3Crect fill="%23e4e4e7" width="56" height="84"/%3E%3C/svg%3E';
        saved.forEach(function (book, idx) {
          var li = document.createElement('li');
          li.className = 'saved-book-item';

          var starsHtml = '';
          if (book.sriRating && book.sriRating > 0) {
            starsHtml = '<div class="saved-book-item-stars">' + miniStarsHtml(book.sriRating) + '</div>';
          }

          var reactionClass = book.reaction === 'like' ? 'liked' : '';
          var reactionBtn = '<button class="saved-book-reaction ' + reactionClass + '" data-idx="' + idx + '" title="' + (book.reaction || 'No reaction') + '">' + reactionIconHtml(book.reaction) + '</button>';
          var removeBtn = '<button class="saved-book-remove" data-idx="' + idx + '" title="Remove"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>';

          li.innerHTML =
            '<img src="' + (book.coverUrl || placeholderCover) + '" alt="Cover of ' + (book.title || '').replace(/"/g, '&quot;') + '" loading="lazy">' +
            '<div class="saved-book-item-info">' +
              '<span class="saved-book-item-title">' + (book.title || '').replace(/</g, '&lt;') + '</span>' +
              '<span class="saved-book-item-author">by ' + (book.author || '').replace(/</g, '&lt;') + '</span>' +
              starsHtml +
            '</div>' +
            reactionBtn +
            removeBtn;
          list.appendChild(li);
        });

        // Wire reaction toggle on saved list items (update in-place, no full re-render)
        list.querySelectorAll('.saved-book-reaction').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var i = parseInt(btn.getAttribute('data-idx'));
            var all = getSavedBooks();
            if (!all[i]) return;
            // Toggle: no reaction -> like, like -> null
            all[i].reaction = all[i].reaction === 'like' ? null : 'like';
            setSavedBooks(all);
            // Update button in-place instead of re-rendering the whole list
            var newReaction = all[i].reaction;
            btn.className = 'saved-book-reaction' + (newReaction === 'like' ? ' liked' : '');
            btn.title = newReaction || 'No reaction';
            btn.innerHTML = reactionIconHtml(newReaction);
          });
        });

        // Wire remove buttons with confirmation (remove DOM element in-place)
        list.querySelectorAll('.saved-book-remove').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var i = parseInt(btn.getAttribute('data-idx'));
            var all = getSavedBooks();
            if (!all[i]) return;
            var title = all[i].title || 'this book';
            if (!confirm('Remove "' + title + '" from saved books?')) return;
            all.splice(i, 1);
            setSavedBooks(all);
            // Remove just this <li> from the DOM
            var li = btn.closest('.saved-book-item');
            if (li) li.remove();
            // Hide the section if no books left
            if (all.length === 0) {
              document.getElementById('saved-books-section').classList.add('hidden');
            }
          });
        });
      }

      renderSavedList();
    })();
  </script>
</body>
</html>
