<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VCHST4LH57"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-VCHST4LH57');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Recommendation – Sri's Book Recommendations</title>
  <meta name="description" content="Your personalized book recommendation from Sri.">
  <!-- Open Graph / WhatsApp / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://sri-book-recommendations.onrender.com/results.html">
  <meta property="og:title" content="Your Recommendation – Sri's Book Recommendations">
  <meta property="og:description" content="Discover your next favorite book with personalized recommendations.">
  <meta property="og:image" content="https://sri-book-recommendations.onrender.com/og-preview.png">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Your Recommendation – Sri's Book Recommendations">
  <meta name="twitter:description" content="Discover your next favorite book with personalized recommendations.">
  <meta name="twitter:image" content="https://sri-book-recommendations.onrender.com/og-preview.png">
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f4f5;
      --card: #ffffff;
      --text: #1a1a1a;
      --text-muted: #71717a;
      --border: #e4e4e7;
      --btn-bg: #27272a;
      --btn-ghost: #f4f4f5;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 2rem 1.5rem 3rem;
    }

    .page {
      max-width: 640px;
      margin: 0 auto;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-muted);
      text-decoration: none;
      margin-bottom: 2rem;
    }

    .back-link:hover {
      color: var(--text);
    }

    header {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    h1 {
      font-size: clamp(1.75rem, 4vw, 2.25rem);
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    .subtitle {
      font-size: 1rem;
      color: var(--text-muted);
      font-weight: 400;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-inner {
      display: flex;
      flex-wrap: wrap;
    }

    .card-cover {
      flex: 0 0 180px;
      min-height: 270px;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .card-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card-cover-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 1.5rem 1rem;
      width: 100%;
      height: 100%;
      color: var(--text-muted);
      gap: 0.5rem;
    }

    .card-cover-placeholder svg {
      width: 2.5rem;
      height: 2.5rem;
      opacity: 0.4;
    }

    .card-cover-placeholder span {
      font-size: 0.8rem;
      line-height: 1.3;
    }

    .card-body {
      flex: 1 1 280px;
      padding: 1.75rem 1.5rem;
      min-width: 0;
    }

    .card-title {
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.35rem;
      line-height: 1.3;
    }

    .card-author {
      font-size: 0.95rem;
      color: var(--text);
      margin-bottom: 1rem;
    }

    .card-synopsis {
      font-size: 0.95rem;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .card-ratings {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .rating-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .rating-label {
      color: var(--text-muted);
      min-width: 90px;
      flex-shrink: 0;
    }

    .stars {
      display: inline-flex;
      gap: 2px;
      position: relative;
    }

    .stars svg {
      width: 1rem;
      height: 1rem;
    }

    .star-empty {
      fill: var(--border);
    }

    .star-full {
      fill: #f59e0b;
    }

    .star-half {
      fill: url(#half-star-grad);
    }

    .rating-number {
      color: var(--text);
      font-weight: 600;
      margin-left: 0.15rem;
    }

    .rating-count {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .card-actions {
      display: flex;
      gap: 0.75rem;
      padding: 1rem 1.5rem 1.5rem;
      border-top: 1px solid var(--border);
      margin-top: 0;
      flex-wrap: wrap;
    }

    .card-actions .btn {
      flex: 1;
      min-width: 100px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.15s, background 0.15s;
    }

    .btn-like {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-like:hover {
      background: var(--btn-ghost);
    }

    .btn-like .icon {
      width: 1.1em;
      height: 1.1em;
      fill: currentColor;
    }

    .btn-save {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-save:hover {
      background: var(--btn-ghost);
    }

    .btn-save.active {
      background: var(--btn-ghost);
      border-color: var(--text-muted);
    }

    .btn-like .icon-thumbsup,
    .btn-save .icon-bookmark {
      width: 1.1em;
      height: 1.1em;
      flex-shrink: 0;
    }

    .btn-save.saved {
      background: var(--btn-ghost);
      border-color: var(--text-muted);
    }

    .btn-like.active {
      background: var(--btn-bg);
      color: #fff;
    }

    .saved-books {
      margin-top: 2.5rem;
    }

    .saved-books.hidden {
      display: none;
    }

    .saved-books h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 1rem;
    }

    .saved-books-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .saved-book-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.25rem;
      background: var(--card);
      border-radius: 10px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .saved-book-item img {
      width: 56px;
      height: 84px;
      object-fit: cover;
      border-radius: 6px;
      background: var(--btn-ghost);
      flex-shrink: 0;
    }

    .saved-book-item-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .saved-book-item-title {
      display: block;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text);
      line-height: 1.3;
    }

    .saved-book-item-author {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .saved-book-item-stars {
      display: flex;
      align-items: center;
      gap: 2px;
      margin-top: 0.15rem;
    }

    .saved-book-item-stars svg {
      width: 0.85rem;
      height: 0.85rem;
    }

    .saved-book-item-stars .rating-val {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      margin-left: 0.3rem;
    }

    .saved-book-reaction {
      flex-shrink: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: none;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.15s;
      color: var(--text-muted);
    }

    .saved-book-reaction:hover {
      background: var(--btn-ghost);
    }

    .saved-book-reaction svg {
      width: 1.1rem;
      height: 1.1rem;
    }

    .saved-book-reaction.liked {
      color: var(--btn-bg);
    }

    .saved-book-remove {
      flex-shrink: 0;
      width: 1.5rem;
      height: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: none;
      cursor: pointer;
      border-radius: 50%;
      color: #cbd5e1;
      transition: color 0.15s, background 0.15s;
      padding: 0;
      margin-left: 0.25rem;
    }

    .saved-book-remove:hover {
      color: #ef4444;
      background: #fef2f2;
    }

    .saved-book-remove svg {
      width: 0.85rem;
      height: 0.85rem;
    }

    .toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      padding: 0.75rem 1.25rem;
      background: var(--text);
      color: #fff;
      font-size: 0.9rem;
      font-weight: 500;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      opacity: 0;
      transform: translateY(0.5rem);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .no-recommendation {
      text-align: center;
      padding: 2rem;
      background: var(--card);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .no-recommendation.hidden {
      display: none;
    }

    /* ── Responsive ── */

    /* Mobile */
    @media (max-width: 520px) {
      body {
        padding: 1.5rem 1rem 5rem;
      }

      header {
        margin-bottom: 1.5rem;
      }

      .back-link {
        margin-bottom: 1.25rem;
        font-size: 1rem;
        padding: 0.75rem 1.25rem;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        text-align: center;
        display: block;
        position: fixed;
        bottom: 1rem;
        left: 1rem;
        right: 1rem;
        z-index: 100;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      }

      /* Stack cover on top, body below */
      .card-inner {
        flex-direction: column;
      }

      .card-cover {
        flex: none;
        width: 100%;
        min-height: 220px;
        max-height: 300px;
      }

      .card-cover img {
        max-height: 300px;
        object-fit: contain;
        background: var(--bg);
      }

      .card-body {
        flex: none;
        padding: 1.25rem 1rem;
      }

      .card-title {
        font-size: 1.15rem;
      }

      .card-author {
        font-size: 0.9rem;
      }

      .card-synopsis {
        font-size: 0.9rem;
      }

      .rating-label {
        min-width: 75px;
      }

      .card-actions {
        padding: 0.75rem 1rem 1.25rem;
        gap: 0.5rem;
      }

      .card-actions .btn {
        font-size: 0.9rem;
        padding: 0.65rem 1rem;
        min-width: 80px;
      }

      .saved-books {
        margin-top: 2rem;
      }

      .saved-book-item {
        padding: 0.75rem 1rem;
        gap: 0.75rem;
      }

      .saved-book-item img {
        width: 48px;
        height: 72px;
      }

      .saved-book-item-title {
        font-size: 0.9rem;
      }

      .saved-book-item-author {
        font-size: 0.8rem;
      }

      .toast {
        left: 1rem;
        right: 1rem;
        bottom: 1rem;
        text-align: center;
      }
    }

    /* Small mobile (very narrow) */
    @media (max-width: 380px) {
      .card-actions {
        flex-direction: column;
      }

      .card-actions .btn {
        width: 100%;
      }
    }

    /* Tablet */
    @media (min-width: 521px) and (max-width: 768px) {
      body {
        padding: 2rem 1.5rem 3rem;
      }

      .card-cover {
        flex: 0 0 160px;
        min-height: 240px;
      }

      .card-body {
        padding: 1.5rem 1.25rem;
      }
    }

    /* Desktop */
    @media (min-width: 769px) {
      .page {
        max-width: 680px;
      }
    }
  </style>
</head>
<body>
  <!-- SVG gradient for half-star rendering (hidden, referenced by CSS) -->
  <svg width="0" height="0" style="position:absolute;">
    <defs>
      <linearGradient id="half-star-grad">
        <stop offset="50%" stop-color="#f59e0b"/>
        <stop offset="50%" stop-color="#e4e4e7"/>
      </linearGradient>
    </defs>
  </svg>

  <div class="page">
    <a href="index.html" class="back-link">← Back to Recommendations</a>

    <header>
      <h1>Sri's Book Recommendations</h1>
      <p class="subtitle">Discover your next favorite book with personalized recommendations</p>
    </header>

    <div class="no-recommendation hidden" id="no-recommendation">
      <p>No recommendation data. <a href="index.html">Get a recommendation</a> first.</p>
    </div>

    <article class="card" id="recommendation-card">
      <div class="card-inner">
        <div class="card-cover" id="card-cover">
          <img id="card-cover-img" src="" alt="" loading="lazy" style="display:none;">
          <div class="card-cover-placeholder" id="card-cover-placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
            <span>Loading cover…</span>
          </div>
        </div>
        <div class="card-body">
          <h2 class="card-title" id="card-title"></h2>
          <p class="card-author" id="card-author"></p>
          <p class="card-synopsis" id="card-synopsis"></p>
          <div class="card-ratings" id="card-ratings" style="display:none;">
            <div class="rating-row">
              <span class="rating-label">Sri's Rating</span>
              <span class="stars" id="sri-stars"></span>
              <span class="rating-number" id="sri-rating-num"></span>
            </div>
            <div class="rating-row">
              <span class="rating-label">Goodreads</span>
              <span class="stars" id="gr-stars"></span>
              <span class="rating-number" id="gr-rating-num"></span>
              <span class="rating-count" id="gr-rating-count"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="card-actions">
        <button type="button" class="btn btn-like" aria-pressed="false">
          <svg class="icon-thumbsup" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M2 20h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1H2v11zm19.83-7.12c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66a4.8 4.8 0 0 0-.88-1.22L14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.84C7 18.95 8.05 20 9.34 20h8.11c.7 0 1.36-.37 1.72-.97l2.66-6.15z"/></svg>
          Like
        </button>
        <button type="button" class="btn btn-save" id="save-btn">
          <svg class="icon-bookmark" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" aria-hidden="true"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
          Save
        </button>
      </div>
    </article>

    <section class="saved-books hidden" id="saved-books-section" aria-label="Saved books">
      <h2>Saved Books</h2>
      <ul class="saved-books-list" id="saved-books-list"></ul>
    </section>
  </div>

  <div class="toast" id="toast" aria-live="polite">book saved</div>

  <script>
    (function () {
      var SAVED_KEY = 'bookRecommendationSaved';
      var currentBook = { id: '', title: '', author: '', synopsis: '', coverUrl: '' };

      var cardEl = document.getElementById('recommendation-card');
      var noRecEl = document.getElementById('no-recommendation');
      var data = sessionStorage.getItem('recommendationResult');
      var books = [];
      try {
        if (data) {
          var parsed = JSON.parse(data);
          books = parsed.books || [];
        }
      } catch (e) {}

      // ---- Open Library (primary) ----
      // Free, no API key, no rate limits. Returns cover_i which maps to a cover URL.
      function fetchCoverFromOpenLibrary(title, author) {
        if (!title) return Promise.resolve('');
        var params = 'title=' + encodeURIComponent(title);
        if (author) params += '&author=' + encodeURIComponent(author);
        var url = 'https://openlibrary.org/search.json?' + params + '&limit=5&fields=cover_i,title';

        return fetch(url)
          .then(function (res) { return res.json(); })
          .then(function (data) {
            var docs = data.docs || [];
            for (var i = 0; i < docs.length; i++) {
              if (docs[i].cover_i) {
                return 'https://covers.openlibrary.org/b/id/' + docs[i].cover_i + '-M.jpg';
              }
            }
            return '';
          })
          .catch(function () { return ''; });
      }

      // ---- Google Books (fallback) ----
      function extractGoogleCover(data) {
        var items = (data && data.items) || [];
        for (var i = 0; i < items.length; i++) {
          var vol = items[i].volumeInfo;
          if (vol && vol.imageLinks) {
            var imgUrl = vol.imageLinks.thumbnail || vol.imageLinks.smallThumbnail || '';
            if (imgUrl) return imgUrl.replace(/^http:/, 'https:');
          }
        }
        return '';
      }

      function fetchCoverFromGoogle(title, author) {
        if (!title) return Promise.resolve('');
        var q = 'intitle:' + title;
        if (author) q += '+inauthor:' + author;
        var url = 'https://www.googleapis.com/books/v1/volumes?q=' +
          encodeURIComponent(q) + '&maxResults=5';
        return fetch(url)
          .then(function (res) { return res.json(); })
          .then(function (data) { return extractGoogleCover(data); })
          .catch(function () { return ''; });
      }

      // ---- Cover cache (localStorage) ----
      var COVER_CACHE_KEY = 'bookCoverCache';

      function getCoverCache() {
        try {
          return JSON.parse(localStorage.getItem(COVER_CACHE_KEY)) || {};
        } catch (e) { return {}; }
      }

      function setCoverCache(key, url) {
        try {
          var cache = getCoverCache();
          cache[key] = url;
          localStorage.setItem(COVER_CACHE_KEY, JSON.stringify(cache));
        } catch (e) {}
      }

      // ---- Combined: cache → Open Library → Google Books ----
      function fetchBookCover(title, author) {
        var cacheKey = (title || '').toLowerCase().trim() + '|' + (author || '').toLowerCase().trim();
        var cached = getCoverCache()[cacheKey];
        if (cached !== undefined) return Promise.resolve(cached);

        return fetchCoverFromOpenLibrary(title, author)
          .then(function (url) {
            if (url) return url;
            return fetchCoverFromGoogle(title, author);
          })
          .then(function (url) {
            if (url) return url;
            return fetchCoverFromOpenLibrary(title, '');
          })
          .then(function (url) {
            setCoverCache(cacheKey, url || '');
            return url;
          });
      }

      // Show the cover image or a "not available" placeholder
      function showCover(imgUrl, title) {
        var coverImg = document.getElementById('card-cover-img');
        var placeholder = document.getElementById('card-cover-placeholder');
        if (imgUrl) {
          coverImg.src = imgUrl;
          coverImg.alt = 'Cover of ' + (title || '');
          coverImg.style.display = '';
          coverImg.onerror = function () {
            // Image URL was bad – show fallback
            coverImg.style.display = 'none';
            placeholder.querySelector('span').textContent = 'Cover image not available';
            placeholder.style.display = '';
          };
          placeholder.style.display = 'none';
        } else {
          coverImg.style.display = 'none';
          placeholder.querySelector('span').textContent = 'Cover image not available';
          placeholder.style.display = '';
        }
      }

      // Render star icons into a container element for a given rating (0–5)
      function renderStars(container, rating) {
        container.innerHTML = '';
        var val = parseFloat(rating) || 0;
        var starPath = 'M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z';
        for (var i = 1; i <= 5; i++) {
          var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          svg.setAttribute('viewBox', '0 0 24 24');
          svg.setAttribute('aria-hidden', 'true');
          var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('d', starPath);
          if (val >= i) {
            path.setAttribute('class', 'star-full');
          } else if (val >= i - 0.5) {
            path.setAttribute('class', 'star-half');
          } else {
            path.setAttribute('class', 'star-empty');
          }
          svg.appendChild(path);
          container.appendChild(svg);
        }
      }

      // Format large numbers (e.g. 1200000 → 1.2M)
      function formatCount(num) {
        var n = parseInt(num, 10) || 0;
        if (n >= 1000000) return (n / 1000000).toFixed(1).replace(/\.0$/, '') + 'M ratings';
        if (n >= 1000) return (n / 1000).toFixed(1).replace(/\.0$/, '') + 'K ratings';
        return n + ' ratings';
      }

      if (books.length === 0) {
        noRecEl.classList.remove('hidden');
        if (cardEl) cardEl.style.display = 'none';
      } else {
        noRecEl.classList.add('hidden');
        if (cardEl) cardEl.style.display = '';
        var book = books[0];
        var score = book.match_score;
        // Use goodreads_title for display; fall back to book_title
        var displayTitle = book.goodreads_title || book.book_title || 'Unknown';
        // Use cover_search_title for cover image fetch; fall back to book_title
        var coverSearchTitle = book.cover_search_title || book.book_title || '';

        document.getElementById('card-title').textContent = displayTitle;
        document.getElementById('card-author').textContent = 'by ' + (book.book_author || 'Unknown');
        var maxScore = book.max_score !== undefined ? book.max_score : 5;
        document.getElementById('card-synopsis').textContent = score !== undefined
          ? 'Matches ' + score + '/' + maxScore + ' of your preferences.'
          : 'From your recommendations.';

        // Populate star ratings
        var sriRating = parseFloat(book.sri_Rating) || 0;
        var grAvgRating = parseFloat(book.goodreads_avg_rating) || 0;
        var grCount = book.goodreads_rating_count || 0;

        renderStars(document.getElementById('sri-stars'), sriRating);
        document.getElementById('sri-rating-num').textContent = sriRating.toFixed(1);

        renderStars(document.getElementById('gr-stars'), grAvgRating);
        document.getElementById('gr-rating-num').textContent = grAvgRating.toFixed(2);
        document.getElementById('gr-rating-count').textContent = '(' + formatCount(grCount) + ')';

        document.getElementById('card-ratings').style.display = '';

        // Set up currentBook with basic info first (coverUrl added after fetch)
        currentBook = {
          id: String(book.book_ID || book.book_title || ''),
          title: displayTitle,
          author: book.book_author || '',
          synopsis: '',
          coverUrl: '',
          sriRating: sriRating,
          reaction: null  // 'like' or null
        };

        // Use pre-resolved cover URL from backend if available;
        // otherwise fall back to client-side lookup.
        var backendCover = book.cover_image_url || '';
        if (backendCover) {
          showCover(backendCover, displayTitle);
          currentBook.coverUrl = backendCover;
        } else {
          fetchBookCover(coverSearchTitle, book.book_author)
            .then(function (coverUrl) {
              showCover(coverUrl, displayTitle);
              currentBook.coverUrl = coverUrl;
            });
        }
      }

      function getSavedBooks() {
        try {
          var raw = localStorage.getItem(SAVED_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          return [];
        }
      }

      function setSavedBooks(books) {
        localStorage.setItem(SAVED_KEY, JSON.stringify(books));
      }

      function miniStarsHtml(rating) {
        var html = '';
        var fullStars = Math.floor(rating);
        var halfStar = (rating - fullStars) >= 0.25;
        var i;
        for (i = 0; i < fullStars; i++) {
          html += '<svg viewBox="0 0 20 20" fill="#f59e0b"><path d="M10 1.12l2.47 5.01 5.53.8-4 3.9.94 5.5L10 13.77l-4.94 2.6.94-5.5-4-3.9 5.53-.8z"/></svg>';
        }
        if (halfStar) {
          html += '<svg viewBox="0 0 20 20"><defs><linearGradient id="hg"><stop offset="50%" stop-color="#f59e0b"/><stop offset="50%" stop-color="#d1d5db"/></linearGradient></defs><path fill="url(#hg)" d="M10 1.12l2.47 5.01 5.53.8-4 3.9.94 5.5L10 13.77l-4.94 2.6.94-5.5-4-3.9 5.53-.8z"/></svg>';
          fullStars++;
        }
        for (i = fullStars + (halfStar ? 0 : 0); i < 5; i++) {
          if (halfStar && i < fullStars) continue;
          html += '<svg viewBox="0 0 20 20" fill="#d1d5db"><path d="M10 1.12l2.47 5.01 5.53.8-4 3.9.94 5.5L10 13.77l-4.94 2.6.94-5.5-4-3.9 5.53-.8z"/></svg>';
        }
        html += '<span class="rating-val">' + rating.toFixed(1) + '</span>';
        return html;
      }

      function reactionIconHtml(reaction) {
        if (reaction === 'like') {
          return '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M2 20h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1H2v11zm19.83-7.12c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66a4.8 4.8 0 0 0-.88-1.22L14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.84C7 18.95 8.05 20 9.34 20h8.11c.7 0 1.36-.37 1.72-.97l2.66-6.15z"/></svg>';
        }
        // Outline thumbs-up for no reaction
        return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 20h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1H2v11zm19.83-7.12c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66a4.8 4.8 0 0 0-.88-1.22L14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.84C7 18.95 8.05 20 9.34 20h8.11c.7 0 1.36-.37 1.72-.97l2.66-6.15z"/></svg>';
      }

      function renderSavedList() {
        var list = document.getElementById('saved-books-list');
        var section = document.getElementById('saved-books-section');
        var saved = getSavedBooks();
        list.innerHTML = '';
        if (saved.length === 0) {
          section.classList.add('hidden');
          return;
        }
        section.classList.remove('hidden');
        var placeholderCover = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="56" height="84" viewBox="0 0 56 84"%3E%3Crect fill="%23e4e4e7" width="56" height="84"/%3E%3C/svg%3E';
        saved.forEach(function (book, idx) {
          var li = document.createElement('li');
          li.className = 'saved-book-item';

          var starsHtml = '';
          if (book.sriRating && book.sriRating > 0) {
            starsHtml = '<div class="saved-book-item-stars">' + miniStarsHtml(book.sriRating) + '</div>';
          }

          var reactionClass = book.reaction === 'like' ? 'liked' : '';
          var reactionBtn = '<button class="saved-book-reaction ' + reactionClass + '" data-idx="' + idx + '" title="' + (book.reaction || 'No reaction') + '">' + reactionIconHtml(book.reaction) + '</button>';
          var removeBtn = '<button class="saved-book-remove" data-idx="' + idx + '" title="Remove"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>';

          li.innerHTML =
            '<img src="' + (book.coverUrl || placeholderCover) + '" alt="Cover of ' + (book.title || '').replace(/"/g, '&quot;') + '" loading="lazy">' +
            '<div class="saved-book-item-info">' +
              '<span class="saved-book-item-title">' + (book.title || '').replace(/</g, '&lt;') + '</span>' +
              '<span class="saved-book-item-author">by ' + (book.author || '').replace(/</g, '&lt;') + '</span>' +
              starsHtml +
            '</div>' +
            reactionBtn +
            removeBtn;
          list.appendChild(li);
        });

        // Wire reaction toggle on saved list items (update in-place, no full re-render)
        list.querySelectorAll('.saved-book-reaction').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var i = parseInt(btn.getAttribute('data-idx'));
            var all = getSavedBooks();
            if (!all[i]) return;
            // Toggle: no reaction -> like, like -> null
            all[i].reaction = all[i].reaction === 'like' ? null : 'like';
            setSavedBooks(all);
            // Update button in-place instead of re-rendering the whole list
            var newReaction = all[i].reaction;
            btn.className = 'saved-book-reaction' + (newReaction === 'like' ? ' liked' : '');
            btn.title = newReaction || 'No reaction';
            btn.innerHTML = reactionIconHtml(newReaction);
            // Also update currentBook if it's the same book
            if (currentBook && currentBook.id === all[i].id) {
              currentBook.reaction = newReaction;
              updateReactionButtons();
            }
          });
        });

        // Wire remove buttons with confirmation (remove DOM element in-place)
        list.querySelectorAll('.saved-book-remove').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var i = parseInt(btn.getAttribute('data-idx'));
            var all = getSavedBooks();
            if (!all[i]) return;
            var title = all[i].title || 'this book';
            if (!confirm('Remove "' + title + '" from saved books?')) return;
            var removedId = all[i].id;
            all.splice(i, 1);
            setSavedBooks(all);
            // Remove just this <li> from the DOM
            var li = btn.closest('.saved-book-item');
            if (li) li.remove();
            // Hide the section if no books left
            if (all.length === 0) {
              document.getElementById('saved-books-section').classList.add('hidden');
            }
            // If the removed book is the current one, reset the Save button
            if (currentBook && currentBook.id === removedId) {
              saveBtn.classList.remove('saved');
            }
          });
        });
      }

      function showToast() {
        var toast = document.getElementById('toast');
        toast.classList.add('show');
        clearTimeout(toast._timer);
        toast._timer = setTimeout(function () {
          toast.classList.remove('show');
        }, 2500);
      }

      var likeBtn = document.querySelector('.btn-like');
      var saveBtn = document.getElementById('save-btn');

      // Update Like button visual
      function updateReactionButtons() {
        likeBtn.classList.toggle('active', currentBook.reaction === 'like');
      }

      // Sync reaction change to localStorage if book is already saved
      function syncReactionToSaved() {
        var saved = getSavedBooks();
        var idx = -1;
        saved.forEach(function (b, i) { if (b.id === currentBook.id) idx = i; });
        if (idx !== -1) {
          saved[idx].reaction = currentBook.reaction;
          setSavedBooks(saved);
        }
      }

      likeBtn.addEventListener('click', function () {
        currentBook.reaction = currentBook.reaction === 'like' ? null : 'like';
        updateReactionButtons();
        syncReactionToSaved();
      });

      saveBtn.addEventListener('click', function () {
        var saved = getSavedBooks();
        var exists = saved.some(function (b) { return b.id === currentBook.id; });
        if (exists) return;
        saved.push(currentBook);
        setSavedBooks(saved);
        renderSavedList();
        saveBtn.classList.add('saved');
        showToast();
      });

      renderSavedList();
      if (getSavedBooks().some(function (b) { return b.id === currentBook.id; })) {
        saveBtn.classList.add('saved');
      }
      updateReactionButtons();
    })();
  </script>
</body>
</html>
